## Security > Network Firewall > コンソール使用ガイド

Network Firewallを作成するための手順と作成後のコンソールの使用方法を説明します。

## はじめる

Network Firewallを使うためには、まず、Network Firewallのインスタンスを作成します。

## Network Firewallの作成

### 事前準備

Network Firewallを作成する前に下記のネットワークリソースが必要です。

* 1個のプロジェクト
* 1個のVPC
* 選択されたVPCに属している3つのサブネット
* 選択されたVPCに接続されたインターネットゲートウェイ

**上記のリソースは[Network]カテゴリーで作成可能です。**

### Network Firewallの作成

1. **Security > Network Firewall**に移動します。
2. 各必須項目を全て選択し、下部の**Network Firewall作成**ボタンをクリックします。
    * RBAC:インスタンスオブジェクト照会、 Network Firewallサービスの提供に必要なAPI権限を付与
    * VPC:Network Firewallインスタンスが使用するVPCを選択
    * サブネット: Network Firewallインスタンスが内部トラフィック制御のために使用するサブネットを選択
    * NAT:Network Firewallインスタンスが外部トラフィック制御のために使用するサブネットを選択
    * 外部転送: Network Firewallインスタンスに作成されたトラフィックとログを転送するサブネットを選択

**参考**

* サブネット、 NAT、外部転送に使用するサブネットは、すべて別のサブネットを選択する必要があります。
    * なるべくNHN Cloudコンソールで作成できる最小単位(28ビット)で作成することを推奨します。
* Network Firewallインスタンスは可用領域を分離して冗長化として基本提供されます。
* Security Groupsとは別のサービスとしてNetwork Firewallサービスを使用する場合両方を許可しなければインスタンスにアクセスすることができません。
* Network Firewallが所有しているCIDR帯域と接続が必要なCIDR帯域は重複してはいけません。

### 接続設定

Network Firewallと連動するために、ピアリングゲートウェイの作成およびルーティングを設定します。

[例]

* Network Firewallが使用するVPC(Hub)は10.0.0.0/24で、Network Firewallと接続が必要なVPC(Spoke)は172.16.0.0/24の場合

1. **Network > Routing**に移動してSpoke VPCを選択した後、ルーティングテーブルを変更します。
    * Spoke VPCを選択した後、**ルーティングテーブル変更**ボタンを押して中央集中型ルーティング(CVR)方式に変更します。
2. **Network > Peering Gateway**に移動してピアリングを作成します。
    * Spoke VPCが他のプロジェクトであれば、プロジェクトピアリングを接続し、同じプロジェクトであればピアリングを接続します。
        * ピアリングゲートウェイ接続の詳細については、 [ユーザーガイド](https://docs.nhncloud.com/ko/Network/Peering%20Gateway/ko/console-guide/)を参照してください。
3. **Network > Routing**に移動してHub VPCを選択した後、下記のルーティングを設定します。
    * 対象CIDR: 172.16.0.0/24
    * ゲートウェイ:ピアリング接続後に追加されたピアリングタイプのゲートウェイ
4. **Network > Routing**に移動してSpoke VPCを選択した後、下記のルーティングを設定します。
    * 対象CIDR: 0.0.0.0/0
    * ゲートウェイ:ピアリング接続後に追加されたピアリングタイプのゲートウェイ
5. **Network > Peering Gateway**に移動してルーティングを設定します。
    * 作成されたピアリングを選択して**ルート** タブに移動します。
    * **ピア**または**ローカルルートの変更**ボタンを押して、以下のようにルーティングを設定します。
        * 対象CIDR: 0.0.0.0/0
        * ゲートウェイ: NFW_TRAFFIC_SUBNET_INTERFACE_VIP

Spoke VPCのサブネットが2つ以上あり、Network Firewallを通じてトラフィック制御が必要な場合、以下のルーティングを追加します。

[例]
Spoke VPC(172.16.0.0/24)のサブネットが172.16.0.0/25と172.16.0.128/25の場合
* **Network > Routing**に移動してSpoke VPCを選択した後、下記のルーティング2個を追加します。
    * 対象CIDR: 172.16.0.0/25と172.16.0.128/25
    * ゲートウェイ:ピアリング接続後に追加されたピアリングタイプのゲートウェイ
     
Spoke VPCが2個以上ある場合は、以下のルーティングを追加します。

[例]
Spoke VPC1(172.16.0.0/24)とSpoke VPC2(192.168.0.0/24)の場合
* **Network > Routing**に移動してHub VPCを選択した後、下記のルーティング2個を追加します。
    * Spoke VPC 1
        * 対象CIDR: 172.16.0.0/24
        * ゲートウェイ: Hub VPCとSpoke VPC1の間に追加されたピアリングタイプのゲートウェイ
    * Spoke VPC 2
        * 対象CIDR: 192.168.0.0/24
        * ゲートウェイ: Hub VPCとSpokr VPC2の間に追加されたピアリングタイプのゲートウェイ

## ポリシー
Network Firewallインスタンスを作成すると、ポリシー初期ページに移動します。


* **ポリシー**タブではNetwork Firewallインスタンスと接続されたVPC間のトラフィックとインバウンド/アウトバウンドトラフィックを制御できるポリシーを管理できます。

### メインページ

![main_page.PNG](/ko/images/main_page.png)

* default-denyポリシーは必須ポリシーであり、修正や削除ができません。
* default-denyポリシーでブロックされたログは、**オプション**タブの基本ブロックポリシーログ設定で確認できます。

### ポリシー追加

![acl_add.PNG](/ko/images/acl_add.png)

* 出発地、目的地、宛先ポートを基にポリシーを追加できます。
    * すでに作成されたオブジェクトを通じて出発地、目的地、宛先ポートを選択します。
* ポリシーの状態(有効化/無効化)と動作(許可/ブロック)、スケジュールを選択してポリシーを追加できます。

### ポリシーのコピー

![acl_copy.PNG](/ko/images/acl_copy.png)

* 作成されたポリシーをクリックして**コピー**ボタンを押すとポリシーをコピーできます。
    * コピーされたポリシーは無効になります。

### ポリシーの修正

![acl_edit.PNG](/ko/images/acl_edit.png)

* 作成されたポリシーをクリックして**修正**ボタンを押すとポリシーを修正できます。

### ポリシーの移動

![acl_move.PNG](/ko/images/acl_move.png)

* 作成されたポリシーをクリックして**移動**ボタンを押すとポリシーを移動できます。
    * 名前: default-denyポリシーの下には移動できません。

### ポリシーの削除

* 作成されたポリシーをクリックして**削除**ボタンを押すとポリシーを削除できます。
    * **一度削除したポリシーは復元することができず、名前：default-denyポリシーは削除できません。**

### ポリシーの一括ダウンロード

* ポリシータブに作成されているポリシー全体を一度にダウンロードできます。

### ポリシーの一括登録

![acl_batch.PNG](/ko/images/acl_batch.png)

* ダウンロードしたテンプレートを使って、ポリシーを一括で登録できます。

## オブジェクト

* **オブジェクト**タブでは、ポリシーを作成する際に使用するIPとポートを作成します。
    * グループオブジェクトはサブネット、ポート、範囲オブジェクトに対して複数のオブジェクトにグループ化して管理できます。

### 追加

必須項目を入力してオブジェクトを作成します。

* IP
    * タイプ:サブネット、範囲、グループ
* ポート
    * タイプ:ポート、範囲、グループ
    * プロトコル: TCP, UDP, ICMP

### 削除

作成されたオブジェクトをクリックして**削除**ボタンを押すとオブジェクトを削除できます。

* 自動的にNetwork Firewallで生成されたオブジェクトは修正や削除ができません。
* ポリシーで使用中のオブジェクトは、削除後、ALLオブジェクトに変更されます(注意が必要)。

### オブジェクトの一括ダウンロード

* **オブジェクト**タブに作成されているIPとポートオブジェクト全体をそれぞれ一度にダウンロードできます。

## NAT

* **NAT**(ネットワークアドレス変換)タブでは、外部から接続するインスタンスを指定して専用グローバルIPを作成します。
    * **NATは目的地ベースのNATのみを提供し、1:1方式のNATのみ提供します。**
    * **ポートベースのNATは提供しません。**
* 作成されたグローバルIPは**Network > Floating IP**で確認できます。
* NATの作成とは別に許可ポリシーを追加すると通信が可能になります。

### 追加

![nat_add.PNG](/ko/images/nat_add.png)

* **追加(+)**ボタンをクリックしてオブジェクトを選択します。
    * **選択したいオブジェクトはあらかじめ作成されている必要があります。
* **確認**ボタンを押すと、接続された**NAT全公認IP**を確認できます。
    * **作成されたNAT全グローバルIPは任意に変更できません。**

### 削除

* **削除** ボタンをクリックして作成されたNATを削除します。
    * **削除後、NAT全グローバルIPは自動的に削除されます。**

## ログ

**ログ**タブでは、Network Firewallで作成されたログを検索できます。

### 検索

* トラフィック: Network Firewallを経由する際に、許可またはブロックポリシーによって作成されたトラフィックログを検索します。
    * **照会は1か月単位で最大3か月までの過去のデータのみ検索可能です。**
    * 別途のデータ保存が必要な場合、**オプション**タブの**ログ遠隔転送設定**を参照してください。
* Audit:ポリシーの作成および削除など、Network Firewallの変更事項に関するログを検索
    * **照会は最大1か月単位で検索可能で、組織サービスであるCloudTrailでも検索可能です。**

### Excelダウンロード

* トラフィックとAuditログの検索結果を **Excelダウンロード** ボタンからダウンロードできます。

## モニター

* **モニター** タブではNetwork Firewallインスタンスの状態をリアルタイムで確認できます。
    * 検索は最大24時間(1日)以内でのみ可能です。

### 検索

* セッション:現在Network Firewallを介して使用するセッションの数量
* ネットワーク使用量:現在Network Firewallを経由するインバウンド/アウトバウンドトラフィック

## オプション

* **オプション**タブはNetwork Firewall運営に必要なオプションを設定できます。

### ログ設定

* 基本ブロックポリシーログ設定: Network Firewall作成後に必ず作成される基本ブロックポリシーログを保存するかどうかを選択します。
    * 使用を選択すると、基本ブロックポリシーで作成されたログはトラフィックログから検索できます。
* ログ遠隔転送設定:遠隔地にトラフィックログを保存できるオプションを選択します。
    * syslog:最大2つの遠隔地アドレスにログを保存
    * Object Storage: NHN Cloudで提供するObject Storageサービスでログを保存
    * Log & Crash Search: NHN Cloudが提供するLog&Crash Searchサービスでログを保存

### 一般設定

* NAT設定
